
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>forestatrisk.build_data.data &#8212; forestatrisk â€” Modelling and forecasting deforestation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for forestatrisk.build_data.data</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># =====================================================================</span>
<span class="c1"># author          :Ghislain Vieilledent</span>
<span class="c1"># email           :ghislain.vieilledent@cirad.fr, ghislainv@gmail.com</span>
<span class="c1"># web             :https://ecology.ghislainv.fr</span>
<span class="c1"># python_version  :&gt;=2.7</span>
<span class="c1"># license         :GPLv3</span>
<span class="c1"># =====================================================================</span>

<span class="c1"># Standard library imports</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>  <span class="c1"># Python 3 compatibility</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>  <span class="c1"># To explore files in a folder</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>  <span class="c1"># To unzip files</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlretrieve</span>  <span class="c1"># Python 3</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlretrieve</span>  <span class="c1"># urlretrieve with Python 2</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">HTTPError</span>  <span class="c1"># Python 3</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="n">HTTPError</span>  <span class="c1"># HTTPError with Python 2</span>

<span class="c1"># Third party imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">ogr</span>
<span class="kn">from</span> <span class="nn">pywdpa</span> <span class="kn">import</span> <span class="n">get_wdpa</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Local application imports</span>
<span class="kn">from</span> <span class="nn">..misc</span> <span class="kn">import</span> <span class="n">make_dir</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ee_jrc</span><span class="p">,</span> <span class="n">ee_gfc</span>


<span class="c1"># Extent of a shapefile</span>
<div class="viewcode-block" id="extent_shp"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.extent_shp">[docs]</a><span class="k">def</span> <span class="nf">extent_shp</span><span class="p">(</span><span class="n">inShapefile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the extent of a shapefile.</span>

<span class="sd">    This function computes the extent (xmin, xmax, ymin, ymax) of a</span>
<span class="sd">    shapefile.</span>

<span class="sd">    :param inShapefile: Path to the input shapefile.</span>

<span class="sd">    :return: The extent as a tuple (xmin, ymin, xmax, ymax).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">inDriver</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s2">&quot;ESRI Shapefile&quot;</span><span class="p">)</span>
    <span class="n">inDataSource</span> <span class="o">=</span> <span class="n">inDriver</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">inShapefile</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">inLayer</span> <span class="o">=</span> <span class="n">inDataSource</span><span class="o">.</span><span class="n">GetLayer</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="n">inLayer</span><span class="o">.</span><span class="n">GetExtent</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>  <span class="c1"># (xmin, ymin, xmax, ymax)</span></div>


<span class="c1"># tiles_srtm</span>
<div class="viewcode-block" id="tiles_srtm"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.tiles_srtm">[docs]</a><span class="k">def</span> <span class="nf">tiles_srtm</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute lat/long tiles for SRTM data from an extent.</span>

<span class="sd">    This function computes lat/long tiles for SRTM data from an extent</span>
<span class="sd">    in lat/long. See `&lt;http://dwtkns.com/srtm/&gt;`_. SRTM tiles are 5x5</span>
<span class="sd">    degrees. x: -180/+180, y: +60/-60.</span>

<span class="sd">    :param extent_latlong: Extent in lat/long: (xmin, ymin, xmax, ymax).</span>

<span class="sd">    :return: A tuple of two strings indicating tile numbers for lat and long.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Tiles for SRTM data</span>
    <span class="n">xmin_latlong</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ymin_latlong</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">xmax_latlong</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">ymax_latlong</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="c1"># Compute SRTM tile numbers</span>
    <span class="n">tile_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">xmin_latlong</span> <span class="o">+</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
    <span class="n">tile_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">xmax_latlong</span> <span class="o">+</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tile_right</span> <span class="o">==</span> <span class="n">tile_left</span><span class="p">):</span>
        <span class="c1"># Trick to make curl globbing work in data_country.sh</span>
        <span class="n">tile_right</span> <span class="o">=</span> <span class="n">tile_left</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">tile_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="o">-</span><span class="n">ymax_latlong</span> <span class="o">+</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
    <span class="n">tile_bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="o">-</span><span class="n">ymin_latlong</span> <span class="o">+</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tile_bottom</span> <span class="o">==</span> <span class="n">tile_top</span><span class="p">):</span>
        <span class="n">tile_bottom</span> <span class="o">=</span> <span class="n">tile_top</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># Format variables, zfill is for having 01 and not 1</span>
    <span class="n">tiles_long</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_left</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_right</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tiles_lat</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_top</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tile_bottom</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tiles_long</span><span class="p">,</span> <span class="n">tiles_lat</span><span class="p">)</span></div>


<span class="c1"># country_forest_run</span>
<div class="viewcode-block" id="country_forest_run"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_forest_run">[docs]</a><span class="k">def</span> <span class="nf">country_forest_run</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;EPSG:3395&quot;</span><span class="p">,</span>
                       <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;data_raw&quot;</span><span class="p">,</span>
                       <span class="n">keep_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">fcc_source</span><span class="o">=</span><span class="s2">&quot;jrc&quot;</span><span class="p">,</span> <span class="n">perc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">gdrive_remote_rclone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">gdrive_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute forest rasters per country and export them to Google Drive</span>
<span class="sd">    with Google Earth Engine (GEE).</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param proj: Projection definition (EPSG, PROJ.4, WKT) as in</span>
<span class="sd">        GDAL/OGR. Default to &quot;EPSG:3395&quot; (World Mercator).</span>

<span class="sd">    :param output_dir: Directory where shapefile for country border is saved.</span>

<span class="sd">    :param keep_dir: Boolean to keep the output_dir folder. Default</span>
<span class="sd">        to &quot;True&quot; (directory &quot;data_raw&quot; is not deleted).</span>

<span class="sd">    :param fcc_source: Source for forest-cover change data. Can be</span>
<span class="sd">        &quot;gfc&quot; (Global Forest Change) or &quot;jrc&quot; (Joint Research Center)</span>
<span class="sd">        data. Default to &quot;jrc&quot;.</span>

<span class="sd">    :param perc: Tree cover percentage threshold to define forest</span>
<span class="sd">        (only used if ``fcc_source=&quot;gfc&quot;``\\ ).</span>

<span class="sd">    :param gdrive_remote_rclone: Name of the Google Drive remote for rclone.</span>

<span class="sd">    :param gdrive_folder: Name of the Google Drive folder to use.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create directory</span>
    <span class="n">make_dir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Check for existing data</span>
    <span class="n">shp_name</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/gadm36_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_0.shp&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">shp_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># Download the zipfile from gadm.org</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_shp.zip&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://biogeo.ucdavis.edu/data/gadm3.6/shp/gadm36_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_shp.zip&quot;</span>
        <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="c1"># Extract files from zip</span>
        <span class="n">destDir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">destDir</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Compute extent</span>
    <span class="n">extent_latlong</span> <span class="o">=</span> <span class="n">extent_shp</span><span class="p">(</span><span class="n">shp_name</span><span class="p">)</span>

    <span class="c1"># Keep or remove directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_dir</span><span class="p">:</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Google Earth Engine task</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fcc_source</span> <span class="o">==</span> <span class="s2">&quot;jrc&quot;</span><span class="p">):</span>
        <span class="c1"># Check data availability</span>
        <span class="n">data_availability</span> <span class="o">=</span> <span class="n">ee_jrc</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">gdrive_remote_rclone</span><span class="p">,</span>
                                         <span class="n">gdrive_folder</span><span class="p">,</span> <span class="n">iso3</span><span class="p">)</span>
        <span class="c1"># If not available, run GEE</span>
        <span class="k">if</span> <span class="n">data_availability</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run Google Earth Engine&quot;</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">ee_jrc</span><span class="o">.</span><span class="n">run_task</span><span class="p">(</span><span class="n">iso3</span><span class="o">=</span><span class="n">iso3</span><span class="p">,</span>
                                   <span class="n">extent_latlong</span><span class="o">=</span><span class="n">extent_latlong</span><span class="p">,</span>
                                   <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                   <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span>
                                   <span class="n">gdrive_folder</span><span class="o">=</span><span class="n">gdrive_folder</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GEE running on the following extent:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fcc_source</span> <span class="o">==</span> <span class="s2">&quot;gfc&quot;</span><span class="p">):</span>
        <span class="c1"># Check data availability</span>
        <span class="n">data_availability</span> <span class="o">=</span> <span class="n">ee_gfc</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">gdrive_remote_rclone</span><span class="p">,</span>
                                         <span class="n">gdrive_folder</span><span class="p">,</span> <span class="n">iso3</span><span class="p">)</span>
        <span class="c1"># If not available, run GEE</span>
        <span class="k">if</span> <span class="n">data_availability</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Run Google Earth Engine&quot;</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">ee_gfc</span><span class="o">.</span><span class="n">run_task</span><span class="p">(</span><span class="n">perc</span><span class="o">=</span><span class="n">perc</span><span class="p">,</span> <span class="n">iso3</span><span class="o">=</span><span class="n">iso3</span><span class="p">,</span>
                                   <span class="n">extent_latlong</span><span class="o">=</span><span class="n">extent_latlong</span><span class="p">,</span>
                                   <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                   <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span>
                                   <span class="n">gdrive_folder</span><span class="o">=</span><span class="n">gdrive_folder</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GEE running on the following extent:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">))</span></div>


<span class="c1"># country_forest_download</span>
<div class="viewcode-block" id="country_forest_download"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_forest_download">[docs]</a><span class="k">def</span> <span class="nf">country_forest_download</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span>
                            <span class="n">gdrive_remote_rclone</span><span class="p">,</span>
                            <span class="n">gdrive_folder</span><span class="p">,</span>
                            <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Download forest cover data from Google Drive.</span>

<span class="sd">    Download forest cover data from Google Drive in the current</span>
<span class="sd">    working directory. Print a message if the file is not available.</span>

<span class="sd">    RClone program is needed: `&lt;https://rclone.org&gt;`_\\ .</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param gdrive_remote_rclone: Google Drive remote name in rclone.</span>

<span class="sd">    :param gdrive_folder: the Google Drive folder to download from.</span>

<span class="sd">    :param output_dir: Output directory to download files to. Default</span>
<span class="sd">        to current working directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check for existing data locally</span>
    <span class="n">srtm_tif</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/forest_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;*.tif&quot;</span>
    <span class="n">raster_list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">srtm_tif</span><span class="p">)</span>

    <span class="c1"># If no data locally check if available in gdrive</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raster_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Data availability in gdrive</span>
        <span class="n">data_availability</span> <span class="o">=</span> <span class="n">ee_jrc</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">gdrive_remote_rclone</span><span class="p">,</span>
                                         <span class="n">gdrive_folder</span><span class="p">,</span>
                                         <span class="n">iso3</span><span class="p">)</span>

        <span class="c1"># Donwload if available in gdrive</span>
        <span class="k">if</span> <span class="n">data_availability</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Commands to download results with rclone</span>
            <span class="n">remote_path</span> <span class="o">=</span> <span class="n">gdrive_remote_rclone</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">gdrive_folder</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;&#39;forest_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;*.tif&#39;&quot;</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rclone&quot;</span><span class="p">,</span> <span class="s2">&quot;copy&quot;</span><span class="p">,</span> <span class="s2">&quot;--include&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span>
                   <span class="n">remote_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">]</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data for </span><span class="si">{0:3s}</span><span class="s2"> has been downloaded&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iso3</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data for </span><span class="si">{0:3s}</span><span class="s2"> is not available&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iso3</span><span class="p">))</span></div>


<span class="c1"># country_wdpa</span>
<div class="viewcode-block" id="country_wdpa"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_wdpa">[docs]</a><span class="k">def</span> <span class="nf">country_wdpa</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to download the protected areas per country.</span>

<span class="sd">    Protected areas comes from the World Database on Protected Areas</span>
<span class="sd">    (\\ `&lt;https://www.protectedplanet.net/&gt;`_\\ ). This function uses the</span>
<span class="sd">    pywdpa python package.</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param output_dir: Directory where shapefiles for protected areas</span>
<span class="sd">        are downloaded. Default to current working directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create directory</span>
    <span class="n">make_dir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Check for existing data</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/pa_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;.shp&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">owd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">get_wdpa</span><span class="p">(</span><span class="n">iso3</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">owd</span><span class="p">)</span></div>


<span class="c1"># country_osm</span>
<div class="viewcode-block" id="country_osm"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_osm">[docs]</a><span class="k">def</span> <span class="nf">country_osm</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to download OSM data for a country.</span>

<span class="sd">    Function to download OpenStreetMap data from Geofabrik.de or</span>
<span class="sd">    OpenStreetMap.fr for aspecific country.</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param output_dir: Directory where data is downloaded. Default to</span>
<span class="sd">        current working directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create directory</span>
    <span class="n">make_dir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Check for existing data</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;country.osm.pbf&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Identify continent and country from iso3</span>
        <span class="n">file_run</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;forestatrisk&quot;</span><span class="p">,</span>
                                                   <span class="s2">&quot;data/ctry_run.csv&quot;</span><span class="p">)</span>
        <span class="n">data_run</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_run</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Check if data is available on Geofabrik</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">data_run</span><span class="o">.</span><span class="n">ctry_geofab</span><span class="p">[</span><span class="n">data_run</span><span class="o">.</span><span class="n">iso3</span> <span class="o">==</span> <span class="n">iso3</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># Country</span>
            <span class="n">country</span> <span class="o">=</span> <span class="n">data_run</span><span class="o">.</span><span class="n">ctry_geofab</span><span class="p">[</span><span class="n">data_run</span><span class="o">.</span><span class="n">iso3</span> <span class="o">==</span> <span class="n">iso3</span><span class="p">]</span>
            <span class="n">country</span> <span class="o">=</span> <span class="n">country</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Continent</span>
            <span class="n">continent</span> <span class="o">=</span> <span class="n">data_run</span><span class="o">.</span><span class="n">cont_geofab</span><span class="p">[</span><span class="n">data_run</span><span class="o">.</span><span class="n">iso3</span> <span class="o">==</span> <span class="n">iso3</span><span class="p">]</span>
            <span class="n">continent</span> <span class="o">=</span> <span class="n">continent</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Download OSM data from Geofabrik</span>
            <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://download.geofabrik.de/&quot;</span><span class="p">,</span> <span class="n">continent</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                   <span class="n">country</span><span class="p">,</span> <span class="s2">&quot;-latest.osm.pbf&quot;</span><span class="p">]</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="c1"># Else use openstreetmap.fr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Country</span>
            <span class="n">country</span> <span class="o">=</span> <span class="n">data_run</span><span class="o">.</span><span class="n">ctry_osmfr</span><span class="p">[</span><span class="n">data_run</span><span class="o">.</span><span class="n">iso3</span> <span class="o">==</span> <span class="n">iso3</span><span class="p">]</span>
            <span class="n">country</span> <span class="o">=</span> <span class="n">country</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Continent</span>
            <span class="n">continent</span> <span class="o">=</span> <span class="n">data_run</span><span class="o">.</span><span class="n">cont_osmfr</span><span class="p">[</span><span class="n">data_run</span><span class="o">.</span><span class="n">iso3</span> <span class="o">==</span> <span class="n">iso3</span><span class="p">]</span>
            <span class="n">continent</span> <span class="o">=</span> <span class="n">continent</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Download OSM data from openstreetmap.fr</span>
            <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://download.openstreetmap.fr/extracts/&quot;</span><span class="p">,</span> <span class="n">continent</span><span class="p">,</span>
                   <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="s2">&quot;.osm.pbf&quot;</span><span class="p">]</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span></div>


<span class="c1"># country_srtm</span>
<div class="viewcode-block" id="country_srtm"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_srtm">[docs]</a><span class="k">def</span> <span class="nf">country_srtm</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to download SRTM data for a country.</span>

<span class="sd">    Function to download SRTM data (Shuttle Radar Topographic Mission</span>
<span class="sd">    v4.1) from CSI-CGIAR for a specific country.</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param output_dir: Directory where data is downloaded. Default to</span>
<span class="sd">        current working directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create directory</span>
    <span class="n">make_dir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Check for existing data</span>
    <span class="n">shp_name</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/gadm36_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_0.shp&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">shp_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># Download the zipfile from gadm.org</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_shp.zip&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://biogeo.ucdavis.edu/data/gadm3.6/shp/gadm36_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_shp.zip&quot;</span>
        <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="c1"># Extract files from zip</span>
        <span class="n">destDir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">destDir</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Compute extent and SRTM tiles</span>
    <span class="n">extent_latlong</span> <span class="o">=</span> <span class="n">extent_shp</span><span class="p">(</span><span class="n">shp_name</span><span class="p">)</span>
    <span class="n">tiles_long</span><span class="p">,</span> <span class="n">tiles_lat</span> <span class="o">=</span> <span class="n">tiles_srtm</span><span class="p">(</span><span class="n">extent_latlong</span><span class="p">)</span>
    <span class="n">tiles_long</span> <span class="o">=</span> <span class="n">tiles_long</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">tiles_lat</span> <span class="o">=</span> <span class="n">tiles_lat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="c1"># Convert to list of integers</span>
    <span class="n">tiles_long</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tiles_long</span><span class="p">]</span>
    <span class="n">tiles_lat</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tiles_lat</span><span class="p">]</span>
    <span class="n">tlong_seq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tiles_long</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tiles_long</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">tlat_seq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tiles_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tiles_lat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Download SRTM data from CSI CGIAR</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tlong_seq</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tlat_seq</span><span class="p">)):</span>
            <span class="c1"># Convert to string</span>
            <span class="n">tlong</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tlong_seq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">tlat</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tlat_seq</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Check for existing data</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/SRTM_V41_&quot;</span> <span class="o">+</span> <span class="n">tlong</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tlat</span> <span class="o">+</span> <span class="s2">&quot;.zip&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Download</span>
                <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://srtm.csi.cgiar.org/&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;wp-content/uploads/files/srtm_5x5/TIFF/srtm_&quot;</span><span class="p">,</span> <span class="n">tlong</span><span class="p">,</span>
                       <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">tlat</span><span class="p">,</span> <span class="s2">&quot;.zip&quot;</span><span class="p">]</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SRTM not existing for tile: &quot;</span> <span class="o">+</span> <span class="n">tlong</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">tlat</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span></div>


<span class="c1"># country_gadm</span>
<div class="viewcode-block" id="country_gadm"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_gadm">[docs]</a><span class="k">def</span> <span class="nf">country_gadm</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to download GADM data for a country.</span>

<span class="sd">    Function to download GADM (Global Administrative Areas) for a</span>
<span class="sd">    specific country. See `&lt;https://gadm.org&gt;`_\\ .</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param output_dir: Directory where data is downloaded. Default to</span>
<span class="sd">        current working directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create directory</span>
    <span class="n">make_dir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Check for existing data</span>
    <span class="n">shp_name</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/gadm36_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_0.shp&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">shp_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># Download the zipfile from gadm.org</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_shp.zip&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://biogeo.ucdavis.edu/data/gadm3.6/shp/gadm36_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_shp.zip&quot;</span>
        <span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="c1"># Extract files from zip</span>
        <span class="n">destDir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">destDir</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># country_download</span>
<div class="viewcode-block" id="country_download"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_download">[docs]</a><span class="k">def</span> <span class="nf">country_download</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span>
                     <span class="n">gdrive_remote_rclone</span><span class="p">,</span> <span class="n">gdrive_folder</span><span class="p">,</span>
                     <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to download data for a specific country.</span>

<span class="sd">    Function to download all the data for a specific country. It</span>
<span class="sd">    includes GEE forest data, GADM, OSM, SRTM, and WDPA data.</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param gdrive_remote_rclone: Google Drive remote name in rclone.</span>

<span class="sd">    :param gdrive_folder: the Google Drive folder to download from.</span>

<span class="sd">    :param output_dir: Directory where data is downloaded. Default to</span>
<span class="sd">        current working directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Message</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading data for country &quot;</span> <span class="o">+</span> <span class="n">iso3</span><span class="p">)</span>

    <span class="c1"># Create directory</span>
    <span class="n">make_dir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># GADM</span>
    <span class="n">country_gadm</span><span class="p">(</span><span class="n">iso3</span><span class="o">=</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># SRTM</span>
    <span class="n">country_srtm</span><span class="p">(</span><span class="n">iso3</span><span class="o">=</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># WDPA</span>
    <span class="n">country_wdpa</span><span class="p">(</span><span class="n">iso3</span><span class="o">=</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># OSM</span>
    <span class="n">country_osm</span><span class="p">(</span><span class="n">iso3</span><span class="o">=</span><span class="n">iso3</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Forest</span>
    <span class="n">country_forest_download</span><span class="p">(</span>
        <span class="n">iso3</span><span class="o">=</span><span class="n">iso3</span><span class="p">,</span>
        <span class="n">gdrive_remote_rclone</span><span class="o">=</span><span class="n">gdrive_remote_rclone</span><span class="p">,</span>
        <span class="n">gdrive_folder</span><span class="o">=</span><span class="n">gdrive_folder</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">)</span></div>


<span class="c1"># country_compute</span>
<div class="viewcode-block" id="country_compute"><a class="viewcode-back" href="../../../reference.html#forestatrisk.build_data.data.country_compute">[docs]</a><span class="k">def</span> <span class="nf">country_compute</span><span class="p">(</span><span class="n">iso3</span><span class="p">,</span>
                    <span class="n">temp_dir</span><span class="o">=</span><span class="s2">&quot;data_raw&quot;</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
                    <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;EPSG:3395&quot;</span><span class="p">,</span>
                    <span class="n">data_country</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">data_forest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">keep_temp_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function computing and formatting country data.</span>

<span class="sd">    This function computes and formats the country data. Computations</span>
<span class="sd">    are done in a temporary directory where data have been downloaded</span>
<span class="sd">    (default to &quot;data_raw&quot;). Then data are copied to an output</span>
<span class="sd">    directory (default to &quot;data&quot;).</span>

<span class="sd">    :param iso3: Country ISO 3166-1 alpha-3 code.</span>

<span class="sd">    :param temp_dir: Temporary directory for computation.</span>

<span class="sd">    :param output_dir: Output directory.</span>

<span class="sd">    :param proj: Projection definition (EPSG, PROJ.4, WKT) as in</span>
<span class="sd">        GDAL/OGR. Default to &quot;EPSG:3395&quot; (World Mercator).</span>

<span class="sd">    :param data_country: Boolean for running data_country.sh to</span>
<span class="sd">        compute country variables. Default to &quot;True&quot;.</span>

<span class="sd">    :param data_forest: Boolean for running data_forest.sh to</span>
<span class="sd">        compute forest landscape variables. Default to &quot;True&quot;.</span>

<span class="sd">    :param keep_temp_dir: Boolean to keep the temporary directory. Default</span>
<span class="sd">        to &quot;False&quot;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reproject GADM</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;ogr2ogr -overwrite -s_srs EPSG:4326 -t_srs &#39;&quot;</span> <span class="o">+</span> <span class="n">proj</span> <span class="o">+</span> <span class="s2">&quot;&#39; -f &#39;ESRI Shapefile&#39; </span><span class="se">\</span>
<span class="s2">    -lco ENCODING=UTF-8 &quot;</span> <span class="o">+</span> <span class="n">temp_dir</span> <span class="o">+</span> <span class="s2">&quot;/ctry_PROJ.shp &quot;</span> <span class="o">+</span> <span class="n">temp_dir</span> <span class="o">+</span> <span class="s2">&quot;/gadm36_&quot;</span> <span class="o">+</span> <span class="n">iso3</span> <span class="o">+</span> <span class="s2">&quot;_0.shp&quot;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Compute extent</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compute extent&quot;</span><span class="p">)</span>
    <span class="n">extent_proj</span> <span class="o">=</span> <span class="n">extent_shp</span><span class="p">(</span><span class="n">temp_dir</span> <span class="o">+</span> <span class="s2">&quot;/ctry_PROJ.shp&quot;</span><span class="p">)</span>

    <span class="c1"># Region with buffer of 5km</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Region with buffer of 5km&quot;</span><span class="p">)</span>
    <span class="n">xmin_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">extent_proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">ymin_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">extent_proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">xmax_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">extent_proj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">ymax_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">extent_proj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">extent_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin_reg</span><span class="p">,</span> <span class="n">ymin_reg</span><span class="p">,</span> <span class="n">xmax_reg</span><span class="p">,</span> <span class="n">ymax_reg</span><span class="p">)</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">extent_reg</span><span class="p">))</span>

    <span class="c1"># Call data_country.sh</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data_country</span><span class="p">):</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;forestatrisk&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;shell/data_country.sh&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sh &quot;</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">iso3</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">proj</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">extent</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                <span class="n">temp_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Call forest_country.sh</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data_forest</span><span class="p">):</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;forestatrisk&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;shell/forest_country.sh&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sh &quot;</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">iso3</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">proj</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">extent</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">,</span>
                <span class="n">temp_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Keep or remove directory</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_temp_dir</span><span class="p">:</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="c1"># End</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo-far.svg" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Modelling and forecasting deforestation in the tropics</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=ghislainv&repo=forestatrisk&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/get_started.html">Get started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Ghislain Vieilledent.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>